

# ==============================
# âœ… è¦ç´„ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# ==============================
import os, time
from huggingface_hub import InferenceClient
from httpx import ConnectTimeout, ReadTimeout, HTTPError

# ğŸ”‘ Hugging Face ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®š
os.environ["HUGGINGFACEHUB_API_TOKEN"] = ""

MODEL_ID = "Qwen/Qwen3-4B-Instruct-2507"
HF_TOKEN = os.environ["HUGGINGFACEHUB_API_TOKEN"]

def summarize_api(text: str, max_tokens: int = 280, temperature: float = 0.3) -> str:
    """
    Qwen3-4B-Instruct ã‚’ä½¿ã£ã¦æ—¥æœ¬èªã®è¦ç´„ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
    """
    if not HF_TOKEN:
        raise RuntimeError("HUGGINGFACEHUB_API_TOKEN ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")

    client = InferenceClient(model=MODEL_ID, token=HF_TOKEN, timeout=60.0)

    prompt = (
        "ã‚ãªãŸã¯æ—¥æœ¬èªã®è¦ç´„ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®æ–‡ç« ã‚’3ã€œ4è¡Œã§è‡ªç„¶ã«è¦ç´„ã—ã¦ãã ã•ã„ã€‚\n"
        "ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãªã©ã®ä¸è¦ãªæƒ…å ±ã¯çœãã€èª­ã¿ã‚„ã™ãã¾ã¨ã‚ã¦ãã ã•ã„ã€‚\n\n"
        f"ã€å…¥åŠ›ã€‘\n{text}\n\nã€è¦ç´„ã€‘"
    )

    # ç°¡æ˜“ãƒªãƒˆãƒ©ã‚¤ä»˜ã
    for attempt in range(3):
        try:
            resp = client.chat.completions.create(
                messages=[{"role": "user", "content": prompt}],
                max_tokens=max_tokens,
                temperature=temperature,
            )
            return resp.choices[0].message["content"].strip()
        except (ConnectTimeout, ReadTimeout):
            print(f"âš ï¸ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: {attempt+1} å›ç›®ã®ãƒªãƒˆãƒ©ã‚¤ä¸­...")
            time.sleep(2 ** attempt)
        except HTTPError as e:
            if getattr(e.response, "status_code", 500) >= 500:
                print(f"âš ï¸ ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ ({e.response.status_code})ã€ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™...")
                time.sleep(2 ** attempt)
            else:
                raise
    raise TimeoutError("Qwen API ã®å‘¼ã³å‡ºã—ã«ç¹°ã‚Šè¿”ã—å¤±æ•—ã—ã¾ã—ãŸã€‚")

# ==============================
# âœ… å…¥åŠ› & å®Ÿè¡Œ
# ==============================
print("ğŸ“ è¦ç´„ã—ãŸã„ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆè¤‡æ•°è¡ŒOKï¼‰\n")
text = ""
while True:
    line = input()
    if line.strip() == "":
        break
    text += line + "\n"

print("\n--- è¦ç´„çµæœ ---\n")
print(summarize_api(text))
